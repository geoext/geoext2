<!DOCTYPE html>
<html debug="true">
  <head>
    <link rel="stylesheet" type="text/css" href="http://cdn.sencha.io/ext/gpl/4.2.1/resources/css/ext-all.css" />
    <script type="text/javascript" charset="utf-8" src="http://cdn.sencha.io/ext/gpl/4.2.1/ext-all-debug.js" ></script>

    <script src="http://openlayers.org/en/master/build/ol.js"></script>

    <script src="../test-utility.js"></script>

    <script type="text/javascript">
        Ext.Loader.setConfig({
            disableCaching: false,
            enabled: true,
            paths: {
                GeoExt: '../../src/GeoExt'
            }
        });

        Ext.Loader.syncRequire(['GeoExt.panel.Map', 'GeoExt.slider.MapPanelItem']);
 
        function createMap() {
            var map = new ol.Map({view: new ol.View({projection: 'EPSG:4326'})});
            var layer = new ol.layer.Layer({title: "test"});
            map.getLayers().push(layer);
            // add a vector layer, which would fail onmapresize if we render
            // the map before the panel has a layout.
            map.getLayers().push(new ol.layer.Vector({title: "vector layer"}));
            return map;
        }

        function createMapPanel() {
            return Ext.create('GeoExt.panel.Map', {
                renderTo: "mappanel",
                layers: [
                    new ol.layer.Layer({title: "foo"}),
                    new ol.layer.Layer({title: "bar"})
                ],
                stateful: true,
                stateId: "map",
                height: 400,
                width: 600
            });
        }

        function test_mappanel(t) {
            t.plan(4)

            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var moveToCnt;

            var map = createMap();
            map.getView().on('change:center', function() {
                moveToCnt++;
            });

            moveToCnt = 0;

            // destroy any leftover panels on the page, guess() might get
            // confused otherwise
            var leftoverMapPanels = Ext.ComponentQuery.query('gx_mappanel');
            Ext.each(leftoverMapPanels, function(panel) {
                panel.destroy();
            });

            var mapPanel = Ext.create('GeoExt.panel.Map', {
                // panel options
                id: "map-panel",
                title: "GeoExt MapPanel",
                renderTo: "mappanel",
                height: 400,
                width: 600,
                // map panel-specific options
                map: map,
                center: [5, 45],
                zoom: 4
            });
            t.eq(moveToCnt, 1, "map.moveTo called exactly once");
            t.eq(mapPanel.map.getView().getCenter(), [5, 45], "Map center set correctly");
            t.eq(mapPanel.map.getView().getZoom(), 4, "Zoom set correctly");
            t.eq(GeoExt.panel.Map.guess().id, mapPanel.id, "MapPanel guessed correctly");
            
            // since we created the map, we destroy it
            map.setTarget(null);
            
            mapPanel.destroy();

            hideTestIframe();
        }
        
        function test_zoom(t) {
            t.plan(1);

            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var panel = Ext.create('GeoExt.panel.Map', {
                title: "GeoExt MapPanel",
                renderTo: "mappanel",
                height: 400,
                width: 600,
                layers: [new ol.layer.Vector()],
                zoom: 4
            });
            
            t.eq(panel.map.getView().getZoom(), 4, "zoom correctly set");
            
            panel.destroy();

            hideTestIframe();
        }

        function test_extent(t) {
            t.plan(2);

            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var map, panel, log = {};
            
            map = createMap();
            panel = Ext.create('GeoExt.panel.Map', {
                renderTo: "mappanel",
                map: map,
                height: 400,
                width: 600,
                extent: [1, 2, 3, 4]
            });            
            t.eq(map.getView().getCenter(), [2, 3], "center of extent taken");
            // since we created the map, we destroy it
            map.setTarget(null);
            panel.destroy();
            
            map = createMap();
            panel = Ext.create('GeoExt.panel.Map', {
                renderTo: "mappanel",
                map: map,
                height: 400,
                width: 600,
                extent: "1, 2, 3, 4"
            });
            t.eq(map.getView().getCenter(), [2, 3], "center of extent taken when set with string");
            // since we created the map, we destroy it
            map.setTarget(null);
            panel.destroy();
            
            hideTestIframe();
        }
        
        function test_center(t) {
            t.plan(2);

            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var map, panel, log = {};
            
            map = createMap();
            map.getView().on('change:center', function() {
                log.center = map.getView().getCenter();
            });
            panel = Ext.create('GeoExt.panel.Map', {
                renderTo: "mappanel",
                map: map,
                height: 400,
                width: 600,
                center: [1, 2]
            });            
            t.eq(log.center, [1,2], "map center set with array");
            delete log.center;
            // since we created the map, we destroy it
            map.setTarget(null);
            panel.destroy();

            map = createMap();
            map.getView().on('change:center', function() {
                log.center = map.getView().getCenter();
            });
            panel = Ext.create('GeoExt.panel.Map', {
                renderTo: "mappanel",
                map: map,
                height: 400,
                width: 600,
                center: "1, 2"
            });            
            t.eq(log.center, [1, 2], "map center set with string");
            delete log.center;
            // since we created the map, we destroy it
            map.setTarget(null);
            panel.destroy();

            hideTestIframe();
        }
        
        function test_destroy(t) {
            
            /**
             * If the panel is passed an instance of OpenLayers.Map, we don't
             * touch it in the destroy sequence, we only remove our reference
             * to it.  If the panel is passed a map config object, the panel
             * creates the OpenLayers.Map instance, and the panel destroys the
             * map in its destroy sequence.
             */

            t.plan(3);

            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();
            
            var panel = Ext.create('GeoExt.panel.Map', {
                renderTo: "mappanel",
                layers: [
                    new ol.layer.Layer({title: "test"})
                ],
                zoom: 1
            });
            
            t.ok(panel.map instanceof ol.Map, "panel creates a map");
            
            var called = false;
            panel.map.on('change:target', function() {
                called = (panel.map.getTarget() === null);
            });
            try {
                panel.destroy();
                t.ok(called, "panel.destroy calls map setTarget with null arg");
            } catch(err) {
                t.fail("panel.destroy causes problems: " + err);
            }
            t.ok(!panel.map, "panel has no reference to a map");

            hideTestIframe();
        }

        function test_applyState_called(t) {
            t.plan(1);

            // set up

            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var provider, applyState, mapPanel, log;

            provider = new Ext.state.Provider();
            provider.state.map = {};
            Ext.state.Manager.setProvider(provider);

            applyState = GeoExt.panel.Map.prototype.applyState;
            GeoExt.panel.Map.prototype.applyState = function(state) {
                log = true;
            };

            // test

            // test that applyState gets called when the MapPanel is created
            // 1 test
            log = false;
            mapPanel = Ext.create('GeoExt.panel.Map', {
                renderTo: "mappanel",
                stateful: true,
                stateId: "map",
                map: createMap(),
                height: 400,
                width: 600
            });
            t.eq(log, true, "applyState called when creating the MapPanel");

            // tear down

            GeoExt.panel.Map.prototype.applyState = applyState;
            mapPanel.destroy();
            hideTestIframe();
        }

        function test_applyState(t) {
            t.plan(6);

            // set up

            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var state;

            var layers = [
                new ol.layer.Layer({title: "foo", visible: false}),
                new ol.layer.Layer({title: "bar", visible: false})
            ];
            var mapPanel = Ext.create('GeoExt.panel.Map', {
                renderTo: "mappanel",
                stateId: "map",
                height: 400,
                width: 600,
                layers: layers
            });

            // test with numeric and boolean state values
            state = {
                x: 5,
                y: 45,
                zoom: 10
            };
            mapPanel.applyState(state);
            t.eq(mapPanel.center[0], 5,
                 "mapPanel.center.lon correctly set [0]");
            t.eq(mapPanel.center[1], 45,
                 "mapPanel.center.lat correctly set [0]");
            t.eq(mapPanel.zoom, 10,
                 "mapPanel.zoom correctly set [0]");

            // test with string state values
            state = {
                x: "5",
                y: "45",
                zoom: "10"
            };
            mapPanel.applyState(state);
            t.eq(mapPanel.center[0], 5,
                 "mapPanel.center.lon correctly set [1]");
            t.eq(mapPanel.center[1], 45,
                 "mapPanel.center.lat correctly set [1]");
            t.eq(mapPanel.zoom, 10,
                 "mapPanel.zoom correctly set [1]");

            // tear down

            mapPanel.destroy();
            hideTestIframe();
        }

        function test_getState_called_mapmove(t) {
            t.plan(1);

            // set up

            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var getState, mapPanel, log;

            getState = GeoExt.panel.Map.prototype.getState;
            GeoExt.panel.Map.prototype.getState = function(state) {
                log = true;
            };

            mapPanel = createMapPanel();

            // test that getState gets called when the map is moved
            log = false;
            mapPanel.map.getView().setCenter([5, 45]);
            t.delay_call(1, function() {
                t.eq(log, true, "getState called when map is moved");
                // tear down

                GeoExt.panel.Map.prototype.getState = getState;
                mapPanel.destroy();
            });
            hideTestIframe();
        }

        function test_getState_called_addlayer(t) {
            t.plan(1);

            // set up

            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var getState, mapPanel, log;

            getState = GeoExt.panel.Map.prototype.getState;
            GeoExt.panel.Map.prototype.getState = function(state) {
                log = true;
            };

            mapPanel = createMapPanel();

            // test that getState gets called when the a layer is
            // added to the map
            log = false;
            var l = new ol.layer.Layer({title: "foo"});
            mapPanel.map.getLayers().push(l);

            t.delay_call(1, function() {
                t.eq(log, true, "getState called when a layer is added to the map");
                // tear down

                GeoExt.panel.Map.prototype.getState = getState;
                mapPanel.destroy();
            });
            hideTestIframe();
        }

        function test_getState_called_removelayer(t) {
            t.plan(1);

            // set up

            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var getState, mapPanel, log;

            getState = GeoExt.panel.Map.prototype.getState;
            GeoExt.panel.Map.prototype.getState = function(state) {
                log = true;
            };

            mapPanel = createMapPanel();
            var l = new ol.layer.Layer({title: "foo"});
            mapPanel.map.getLayers().push(l);
 
            // test that getState gets called when the a layer is
            // removed from the map
            log = false;
            mapPanel.map.getLayers().remove(l);
            t.delay_call(1, function() {
                t.eq(log, true, "getState called when a layer is removed from the map");
                // tear down

                GeoExt.panel.Map.prototype.getState = getState;
                mapPanel.destroy();
            });
            hideTestIframe();
        }

        function test_getState_called_rename(t) {
            t.plan(1);
            
            // set up
            
            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var getState, mapPanel, log;

            getState = GeoExt.panel.Map.prototype.getState;
            GeoExt.panel.Map.prototype.getState = function(state) {
                log = true;
            };

            mapPanel = createMapPanel();

            // test that getState gets called when the a layer is
            // renamed
            log = false;
            mapPanel.map.getLayers().item(0).set('title', 'foo1');
            t.delay_call(1, function() {
                t.eq(log, true, "getState called when a layer is renamed");
                // tear down
            
                GeoExt.panel.Map.prototype.getState = getState;
                mapPanel.destroy();
            });
            hideTestIframe();
        }

        function test_getState_called_reorder(t) {
            t.plan(1);

            // set up
            
            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var getState, mapPanel, log;

            getState = GeoExt.panel.Map.prototype.getState;
            GeoExt.panel.Map.prototype.getState = function(state) {
                log = true;
            };

            mapPanel = createMapPanel();

            // test that getState gets called when the the layer order is
            // changed
            log = false;
            var layer = mapPanel.map.getLayers().item(1);
            mapPanel.map.getLayers().remove(layer);
            mapPanel.map.getLayers().insertAt(1, layer);
            t.delay_call(1, function() {
                t.eq(log, true, "getState called when a layer is raised");
                // tear down
            
                GeoExt.panel.Map.prototype.getState = getState;
                mapPanel.destroy();
            });
            hideTestIframe();
        }

        function test_getState_called_visibility(t) {
            t.plan(1);

            // set up

            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var getState, mapPanel, log;

            getState = GeoExt.panel.Map.prototype.getState;
            GeoExt.panel.Map.prototype.getState = function(state) {
                log = true;
            };

            mapPanel = createMapPanel();

            // test that getState gets called when layer visibility
            // is changed
            log = false;
            mapPanel.map.getLayers().item(0).setVisible(false);
            t.delay_call(1, function() {
                t.eq(log, true, "getState called when layer visibility is changed");

                // tear down

                GeoExt.panel.Map.prototype.getState = getState;
                mapPanel.destroy();
            });
            hideTestIframe();
        }

        function test_getState(t) {
            t.plan(7);

            // set up

            // make the hidden span element visible, because setSize does not
            // work in iframes that are inside a hidden container in FF and IE.
            // (hidden again at the end of the test)
            showTestIframe();

            var state;

            // test

            var layers = [
                new ol.layer.Layer({title: "foo"}),
                new ol.layer.Layer({title: "bar", visible: false})
            ];
            var mapPanel = Ext.create('GeoExt.panel.Map', {
                renderTo: "mappanel",
                stateId: "map",
                height: 400,
                width: 600,
                layers: layers,
                center: [5, 45],
                zoom: 6
            });
            layers[0].setOpacity(0.5);

            state = mapPanel.getState();
            t.eq(state.x, 5,
                 "state.x correctly set");
            t.eq(state.y, 45,
                 "state.y correctly set");
            t.eq(state.zoom, 6,
                 "state.zoom correctly set");
            t.eq(state.visibility_foo, true,
                 "state.visibility_foo correctly set");
            t.eq(state.visibility_bar, false,
                 "state.visibility_bar correctly set");
            t.eq(state.opacity_foo, 0.5,
                 "state.opacity_foo correctly set");
            t.eq(state.opacity_bar, 1,
                 "state.opacity_bar correctly set");

            mapPanel.destroy();
            hideTestIframe();
        }
        
        function test_add(t) {
            showTestIframe();
            t.plan(1);
            var layers = [
                new ol.layer.Layer({title: "foo"}),
                new ol.layer.Layer({title: "bar", visible: false})
            ];
            var mapPanel = Ext.create('GeoExt.panel.Map', {
                renderTo: "mappanel",
                stateId: "map",
                height: 400,
                width: 600,
                layers: layers,
                center: [5, 45],
                zoom: 6,
                items: Ext.create('GeoExt.slider.MapPanelItem', {
                    ref: "zoomSlider"
                })
            });
            t.ok(mapPanel.items.get(0).getEl().dom.parentNode === mapPanel.body.dom,
                 "Map Panel item has the panels's body div as parent.");
            mapPanel.destroy();
            hideTestIframe();
        }

        // This test is originally coming from issue #61:
        // https://github.com/geoext/geoext2/pull/61
        function test_destroyInTabbedPanelTest(t) {
            showTestIframe();
            t.plan(3);

             var layers = [
                 new ol.layer.Layer({title: "foo"}),
                 new ol.layer.Layer({title: "bar", visible: false})
             ];

             var panel = Ext.create('Ext.tab.Panel', {
                 renderTo : 'mappanel',
                 config : {
                     items : [  ]
                 }
             });

             var mappanel = Ext.create('GeoExt.panel.Map', {
                 stateId : "map",
                 height : 400,
                 width : 600,
                 layers : layers,
                 center : [ 5, 45 ],
                 zoom : 6,
                 items : Ext.create('GeoExt.slider.MapPanelItem', {
                     ref : "zoomSlider"
                 })
             });

             panel.add(mappanel);
             panel.removeAll();
             mappanel.destroy();

             t.eq(panel.items.length, 0, "Panel destroy was successful");

             layers = [
                 new ol.layer.Layer({title: "foo"}),
                 new ol.layer.Layer({title: "bar", visible: false})
             ];
             mappanel = Ext.create('GeoExt.panel.Map', {
                 stateId : "map",
                 height : 400,
                 width : 600,
                 layers : layers,
                 center : [ 5, 45 ],
                 zoom : 6,
                 items : Ext.create('GeoExt.slider.MapPanelItem', {
                     ref : "zoomSlider"
                 })
             });
             panel.add(mappanel);

             t.eq(panel.items.length, 1, "Panel added successful");
             panel.removeAll();
             mappanel.destroy();

             t.eq(panel.items.length, 0, "Panel destroy was successful");

             hideTestIframe();
         }
    </script>
  </head>
  <body>
    <div id="mappanel"></div>
  </body>
</html>
